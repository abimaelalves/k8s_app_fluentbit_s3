apiVersion: batch/v1
kind: CronJob
metadata:
  name: check-fluentbit-logs  # Nome do CronJob
spec:
  schedule: "*/5 * * * *"  # Define que o CronJob ser√° executado a cada 5 minutos
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: log-checker
            image: bitnami/aws-cli  # Usa uma imagem que j√° vem com kubectl e AWS CLI pr√©-instalados
            command:
            - /bin/sh
            - -c
            - |
              echo "üîç Verificando logs no S3 do LocalStack..."

              # Define credenciais falsas para acessar o LocalStack via AWS CLI
              export AWS_ACCESS_KEY_ID=test
              export AWS_SECRET_ACCESS_KEY=test
              export AWS_DEFAULT_REGION=us-east-1

              # Configura√ß√µes do LocalStack e do Fluent Bit
              ENDPOINT="http://host.docker.internal:4566"  # Endere√ßo do LocalStack no Docker Desktop
              BUCKET="log-bucket"  # Nome do bucket onde os logs s√£o armazenados
              FLUENTBIT_LABEL="app=fluent-bit"  # R√≥tulo (label) do Fluent Bit para reiniciar caso necess√°rio

              # Obt√©m o timestamp do √∫ltimo log armazenado no bucket do S3
              LAST_LOG_TIME=$(aws --endpoint-url=$ENDPOINT s3 ls s3://$BUCKET/ --recursive | awk '{print $1, $2}' | sort | tail -n 1)

              # Verifica se h√° logs recentes no bucket
              if [ -z "$LAST_LOG_TIME" ]; then
                  echo "üö® Nenhum log encontrado no bucket! Reiniciando Fluent Bit..."
                  kubectl rollout restart deployment -l $FLUENTBIT_LABEL  # Reinicia o deployment do Fluent Bit
              else
                  echo "‚úÖ √öltimo log encontrado em: $LAST_LOG_TIME"
              fi

            # Define vari√°veis de ambiente dentro do container (mesmo que j√° sejam configuradas no script)
            env:
              - name: AWS_ACCESS_KEY_ID
                value: "test"
              - name: AWS_SECRET_ACCESS_KEY
                value: "test"
              - name: AWS_DEFAULT_REGION
                value: "us-east-1"
                
          restartPolicy: OnFailure  # Caso o job falhe, ele ser√° reiniciado automaticamente
          serviceAccountName: fluentbit-check-sa  # Conta de servi√ßo que permite que o job execute comandos no cluster Kubernetes
